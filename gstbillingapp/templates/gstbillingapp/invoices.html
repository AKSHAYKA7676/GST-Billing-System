{# gstbillingapp/templates/gstbillingapp/invoices.html #}
{% extends "gstbillingapp/base.html" %}
{% load static %}
{% block title %}Invoices — GST 2.0{% endblock %}

{% block content %}
<div class="page-title">Invoices & Dashboard</div>

<div class="row mb-3">
  <div class="col-md-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="small text-uppercase">Total Invoices</h6>
        <h3>{{ invoices.count }}</h3>
        <p class="small text-muted">All time invoices</p>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="small text-uppercase">Recent Sales</h6>
        <h3>—</h3>
        <p class="small text-muted">(summary coming soon)</p>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="small text-uppercase">Products</h6>
        <h3>{{ products.count }}</h3>
        <p class="small text-muted">Total product SKUs</p>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="small text-uppercase">Customers</h6>
        <h3>{{ customers.count }}</h3>
        <p class="small text-muted">Total customers</p>
      </div>
    </div>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="mb-0">Invoices</h5>
      <a class="btn btn-sm btn-primary" href="{% url 'invoice_create' %}">Create Invoice</a>
    </div>

    <div class="table-responsive">
      <table id="invoices-table" class="table table-striped table-hover">
        <thead>
          <tr>
            <th>#</th>
            <th>Invoice No</th>
            <th>Date</th>
            <th>Customer</th>
            <th>Amount (₹)</th>
            <th>Inventory</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for inv in invoices %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ inv.invoice_number }}</td>
            <td>{{ inv.invoice_date }}</td>
            <td>{% if inv.invoice_customer %}{{ inv.invoice_customer.customer_name }}{% else %}—{% endif %}</td>
            <td>
              <td>
  {% with data=inv.invoice_json|safe %}
      {% if data %}
          ₹ {{ data|json_script:"invoice_json" }}
          <script>
            const d = JSON.parse(document.getElementById("invoice_json").textContent);
            document.write(d.invoice_total_amt_with_gst ?? "-");
          </script>
      {% else %}
          -
      {% endif %}
  {% endwith %}
</td>

            </td>
            <td>{% if inv.inventory_reflected %}Yes{% else %}<span class="text-danger">No</span>{% endif %}</td>
            <td>
              <a class="btn btn-sm btn-outline-primary" href="{% url 'invoice_viewer' inv.id %}">View</a>
              <form style="display:inline" method="post" action="{% url 'invoice_delete' %}">
                {% csrf_token %}
                <input type="hidden" name="invoice_id" value="{{ inv.id }}">
                <button class="btn btn-sm btn-danger" type="submit">Delete</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% endblock %}

{% block includejs %}
<script>
  $(document).ready(function(){
    $('#invoices-table').DataTable({ "order": [[1, "desc"]] });
  });
</script>
{% endblock %}
